
<!DOCTYPE html>
<html>
<head>
    <title>Employee Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    {% load static %}

    <link rel="stylesheet" href="{% static 'CSS_file/employee_dashB.css' %}">

</head>

<body>
<div class="container">

    <!-- ✅ NAVIGATION -->
<div class="nav">
    <div>
        <div class="brand">Employee Dashboard</div>
        <div class="muted">Welcome, {{ emp.E_name }}</div>
    </div>

    <div class="row">
        <a class="btn btn-danger" href="{% url 'logout' %}">Logout</a>
        {% if emp.is_manager %}
            <a class="btn" href="{% url 'manager_dashboard' %}">Manager</a>
        {% endif %}
    </div>
</div>


    <!-- ✅ MAIN GRID -->
    <div class="layout">

        <!-- ✅ LEFT SIDE: PROFILE -->
        <div class="card">
            <div class="title">Profile</div>

            <div class="row">
                <div class="pill">ID: <strong>{{ emp.E_id }}</strong></div>
                <div class="pill">Role: <strong>{% if emp.is_manager %}Manager{% else %}Employee{% endif %}</strong></div>
                <div class="pill">Salary: <strong>₹{{ emp.salary }}</strong></div>
            </div>

            {% if today_record %}
                <span class="badge {% if today_record.status == 'Present' %}ok{% else %}miss{% endif %}">
                    Today: {{ today_record.status }}
                </span>
            {% else %}
                <span class="badge">Today: Not Marked</span>
            {% endif %}

            <div class="kpis">
                <div class="kpi">
                    <div class="label">Total Days</div>
                    <div class="value">{{ total_days }}</div>
                </div>
                <div class="kpi">
                    <div class="label">Present</div>
                    <div class="value">
                        {{ records|length }}
                    </div>
                </div>
                <div class="kpi">
                    <div class="label">Last Marked</div>
                    <div class="value">{% if records %}{{ records.0.date }}{% else %}-{% endif %}</div>
                </div>
            </div>

            <!-- ✅ QUICK ACTIONS SECTION -->
<div class="action-section card">
    
    <!-- Check-out button -->
   {% if today_record and today_record.check_in_time and not today_record.check_out_time %}
    <div class="status-box checked-in">
        <p class="status-title">
            Arrive at {{ today_record.check_in_time|time:"h:i A" }}
        </p>
        <p class="status-detail">
             Auto-checkout monitoring active (&gt;100m from office)
        </p>
    </div>
    <div  class="action-buttons">
        <a  href="{% url 'checkout' %}?E_id={{ emp.E_id }}" class="btn btn-checkout">
     Manual Depart
</a>

    </div>
{% elif today_record and today_record.check_out_time %}
    <div class="status-box checked-out">
        <p class="status-title">
             Checked in: {{ today_record.check_in_time|time:"h:i A" }} | 
             Checked out: {{ today_record.check_out_time|time:"h:i A" }}
        </p>
        <p class="status-detail">
            ⏱ Hours worked: {{ today_record.hours_worked }} hours
            {% if today_record.auto_checkout %}
                <span class="badge-auto"> Auto Check-out</span>
            {% endif %}
        </p>
    </div>
{% endif %}

    
    <!-- Action buttons -->
    <div class="action-buttons">
        <a href="{% url 'employee_salary_summary' %}?E_id={{ emp.E_id }}" class="btn btn-salary">
             View My Salary
        </a>
        
        <button onclick="location.reload();" class="btn btn-refresh" type="button">
          Refresh Dashboard
         </button>

    </div>
</div>
        </div>


        <!-- ✅ RIGHT SIDE: ATTENDANCE HISTORY -->
        <div class="card"  id="AtteHIstryTable">
            <div class="title">Attendance History</div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr><th>Date</th><th>Status</th></tr>
                    </thead>
                    <tbody>
                    {% for r in records %}
                        <tr>
                            <td>{{ r.date }}</td>
                            <td>
                                <span class="badge {% if r.status == 'Present' %}ok{% else %}miss{% endif %}">
                                    {{ r.status }}
                                </span>
                            </td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="2" class="muted">No attendance found.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>


    <!-- ✅ FULL CALENDAR -->
    <div class="card">
        <div class="title">Attendance Calendar</div>
        <div id="calendar"></div>
    </div>

</div>


<!-- ✅ CALENDAR SCRIPT -->
<script>
    // ✅ Use Django's attendance_map directly
    const attendanceMap = {
        {% for day, status in attendance_map.items %}
            "{{ day }}": "{{ status }}",
        {% endfor %}
    };

    function generateCalendar() {
        const calendar = document.getElementById("calendar");
        const now = new Date();
        
        const month = now.getMonth();  
        const year = now.getFullYear();

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        calendar.innerHTML = `
            <div class="calendar-header">
                ${now.toLocaleString('en-US', { month: 'long' })} ${year}
            </div>
            <div class="calendar-grid"></div>
        `;

        const grid = calendar.querySelector(".calendar-grid");

        // Empty slots before 1st day
        for (let i = 0; i < firstDay; i++) {
            grid.appendChild(document.createElement("div"));
        }

        // Create days
        for (let day = 1; day <= daysInMonth; day++) {
            const cell = document.createElement("div");
            cell.classList.add("calendar-day");
            cell.innerText = day;

            // ✅ Get status from attendance_map
            const status = attendanceMap[day];

            if (status) {
                const dot = document.createElement("div");
                dot.classList.add("dot");
                
                if (status === "Present") {
                    dot.classList.add("present");
                    cell.classList.add("present-day");  // ✅ Green background
                } else {
                    dot.classList.add("absent");
                    cell.classList.add("absent-day");   // ✅ Red background
                }
                
                cell.appendChild(dot);
            }

            grid.appendChild(cell);
        }
    }

    generateCalendar();
</script>

<!-- ✅ AUTO-CHECKOUT MONITORING -->
{% if emp.is_checked_in %}
<script>
// Auto-checkout monitoring - checks location every 60 seconds
function monitorLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            // Send location to server
            fetch("{% url 'update_location' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: `latitude=${lat}&longitude=${lon}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.auto_checked_out) {
                    // Show notification and reload page
                    alert(" You were automatically checked out because you moved " + data.distance + "m from office (>100m limit).");
                    window.location.reload();
                }
                console.log("Location updated - Distance: " + data.distance + "m");
            })
            .catch(error => console.error('Error:', error));
        });
    }
}

// Check location every 60 seconds when checked in
setInterval(monitorLocation, 60000);

// Initial check
monitorLocation();
</script>
{% endif %}

</body>
</html>
