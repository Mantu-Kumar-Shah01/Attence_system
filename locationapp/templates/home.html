<!DOCTYPE html>
<html>
<head>
    <title>Mark Attendance</title>
</head>
<body>
    <h2>ğŸ“ Employee Attendance</h2>
    {% if error %}<p style="color:red">{{ error }}</p>{% endif %}
    <form id="attendanceForm" method="POST">
        {% csrf_token %}
        <label>Employee ID:</label>
        <input type="text" name="E_id" id="empId" required onblur="toggleManagerButton()">
        <input type="hidden" name="latitude" id="lat">
        <input type="hidden" name="longitude" id="lon">
        <button type="button" onclick="getLocation()">Mark Attendance</button>
    </form>

    <div style="margin-top:12px;">
        <a id="managerBtn" href="{% url 'manager_dashboard' %}" style="display:none;border:1px solid #888;padding:6px 10px;border-radius:6px;text-decoration:none;">Manager</a>
    </div>

    <script>
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    document.getElementById("lat").value = pos.coords.latitude;
                    document.getElementById("lon").value = pos.coords.longitude;
                    document.getElementById("attendanceForm").submit();
                });
            } else {
                alert("Geolocation not supported.");
            }
        }

        function toggleManagerButton(){
            const eid = document.getElementById('empId').value.trim();
            const btn = document.getElementById('managerBtn');
            if (!eid) { btn.style.display = 'none'; return; }
            fetch(`/employee_details/?E_id=${encodeURIComponent(eid)}`)
              .then(r => r.json())
              .then(data => {
                if (data && data.is_manager === true) {
                    btn.style.display = 'inline-block';
                } else {
                    btn.style.display = 'none';
                }
              })
              .catch(() => { btn.style.display = 'none'; });
        }

    </script>
</body>
</html>
